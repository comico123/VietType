<?xml version="1.0" encoding="UTF-8"?>
<!--
SPDX-License-Identifier: GPL-3.0-only
-->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <?include Version.wxi ?>

  <Product
    Id="*"
    Name="VietType"
    Language="!(bind.fileLanguage.VietTypeATL32.dll)"
    Version="$(var.productVersion)"
    Manufacturer="Dinh Ngoc Tu"
    UpgradeCode="{E00AC838-881D-4301-AAC5-0A723BB0B0EF}">

    <Package InstallerVersion="400" Compressed="yes" InstallScope="perMachine" Comments="Ver-$(var.productVersion)_Rev-$(var.vcsRev)" />

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      Schedule="afterInstallInitialize" />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="VietType" Absent="disallow" AllowAdvertise="no">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ShortcutComponents" />
    </Feature>

    <Feature Id="ConfigFeature" Title="Configuration tool" AllowAdvertise="no">
      <ComponentGroupRef Id="ConfigComponents" />
    </Feature>

    <Feature Id="DebugSymbolsFeature" Title="Debug symbols" AllowAdvertise="no">
      <ComponentGroupRef Id="DebugSymbols" />
    </Feature>

    <UIRef Id="WixUI_Minimal" />
    <WixVariable Id="WixUILicenseRtf" Value="licembed.rtf" />

    <Condition Message="VietType is only compatible with Windows 8 and newer.">Installed OR (VersionNT >= 602)</Condition>

    <?if $(var.Platform) = x86 ?>
    <Condition Message="32-bit setup can only run on a 32-bit OS.">Installed OR (NOT VersionNT64)</Condition>
    <?endif ?>

    <SetProperty Id="RegisterCategories" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunRegisterCategories' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="RegisterCategoriesRollback" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunUnregisterCategories' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="UnregisterCategories" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunUnregisterCategories' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="UnregisterCategoriesRollback" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunRegisterCategories' After="CostFinalize" Sequence="execute" />

    <SetProperty Id="RegisterProfiles" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunRegisterProfiles' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="RegisterProfilesRollback" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunUnregisterProfiles' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="UnregisterProfiles" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunUnregisterProfiles' After="CostFinalize" Sequence="execute" />
    <SetProperty Id="UnregisterProfilesRollback" Value='"[%SystemRoot]\System32\rundll32.exe" "[#VietTypeATL32.dll]",RunRegisterProfiles' After="CostFinalize" Sequence="execute" />

    <InstallExecuteSequence>
      <Custom Action="RegisterCategoriesRollback" After="InstallFiles">(NOT Installed) OR REINSTALL</Custom>
      <Custom Action="RegisterCategories" After="RegisterCategoriesRollback">(NOT Installed) OR REINSTALL</Custom>
      <Custom Action="RegisterProfilesRollback" After="RegisterCategories">(NOT Installed) OR REINSTALL</Custom>
      <Custom Action="RegisterProfiles" After="RegisterProfilesRollback">(NOT Installed) OR REINSTALL</Custom>

      <Custom Action="UnregisterProfilesRollback" After="InstallInitialize">REMOVE OR REINSTALL</Custom>
      <Custom Action="UnregisterProfiles" After="UnregisterProfilesRollback">REMOVE OR REINSTALL</Custom>
      <Custom Action="UnregisterCategoriesRollback" After="UnregisterProfiles">REMOVE OR REINSTALL</Custom>
      <Custom Action="UnregisterCategories" After="UnregisterCategoriesRollback">REMOVE OR REINSTALL</Custom>
    </InstallExecuteSequence>
  </Product>

  <!-- ################################################################################ -->
  <!-- install paths -->

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="VietType" />
      </Directory>
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER64" Name="VietType" />
      </Directory>
    </Directory>
  </Fragment>

  <!-- ################################################################################ -->
  <!-- main files -->

  <Fragment>
    <ComponentGroup Id="ProductComponents">
      <Component Id="VietTypeATL32.dll" Win64="no" Directory="INSTALLFOLDER">
        <File Source="$(var.SolutionDir)\Win32\$(var.Configuration)\VietTypeATL32.dll">
          <Class Id="{C0DD01A1-0DEB-454B-8B42-D22CED1B4B23}" Context="InprocServer32" Description="VietType" ThreadingModel="apartment" />
        </File>
      </Component>

      <?if $(var.Platform) = x64 ?>
      <Component Id="VietTypeATL64.dll" Win64="yes" Directory="INSTALLFOLDER64">
        <File Source="$(var.SolutionDir)\x64\$(var.Configuration)\VietTypeATL64.dll">
          <Class Id="{C0DD01A1-0DEB-454B-8B42-D22CED1B4B23}" Context="InprocServer32" Description="VietType" ThreadingModel="apartment" />
        </File>
      </Component>
      <?endif ?>

      <Component Win64="no" Directory="INSTALLFOLDER">
        <File Source="$(var.SolutionDir)\LICENSE" DefaultLanguage="1033" DefaultVersion="$(var.productVersion)" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- ################################################################################ -->
  <!-- shortcuts -->

  <Fragment>
    <DirectoryRef Id="TARGETDIR">
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ShortcutFolder" Name="VietType" />
      </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ShortcutComponents" Directory="ShortcutFolder">
      <Component>
        <Shortcut Id="ActivateShortcut" Name="Enable VietType" Target="[%SystemRoot]\System32\rundll32.exe" Arguments='"[!VietTypeATL32.dll]",RunActivateProfiles' WorkingDirectory="INSTALLFOLDER" />
        <Shortcut Id="DeactivateShortcut" Name="Disable VietType" Target="[%SystemRoot]\System32\rundll32.exe" Arguments='"[!VietTypeATL32.dll]",RunDeactivateProfiles' WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanupShortcuts" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\VietType" Name="RegistrarShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- ################################################################################ -->
  <!-- config -->

  <Fragment>
    <ComponentGroup Id="ConfigComponents">
      <Component Win64="no" Directory="INSTALLFOLDER">
        <File Source="$(var.SolutionDir)\VietTypeConfig\bin\$(var.Configuration)\VietTypeConfig.exe" />
        <Shortcut Id="ConfigShortcut" Directory="ShortcutFolder" Name="VietType Settings" WorkingDirectory="INSTALLFOLDER" Advertise="yes" />
      </Component>
      <Component Win64="no" Directory="INSTALLFOLDER">
        <File Source="$(var.SolutionDir)\VietTypeConfig\bin\$(var.Configuration)\VietTypeConfig.exe.config"
              DefaultLanguage="!(bind.fileLanguage.VietTypeConfig.exe)" DefaultVersion="!(bind.fileVersion.VietTypeConfig.exe)" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!-- ################################################################################ -->
  <!-- symbols -->

  <Fragment>
    <ComponentGroup Id="DebugSymbols">
      <Component Win64="no" Directory="INSTALLFOLDER">
        <File Source="$(var.SolutionDir)\Win32\$(var.Configuration)\VietTypeATL32.pdb"
              DefaultLanguage="!(bind.fileLanguage.VietTypeATL32.dll)" DefaultVersion="!(bind.fileVersion.VietTypeATL32.dll)" />
      </Component>

      <?if $(var.Platform) = x64 ?>
      <Component Win64="yes" Directory="INSTALLFOLDER64">
        <File Source="$(var.SolutionDir)\x64\$(var.Configuration)\VietTypeATL64.pdb"
              DefaultLanguage="!(bind.fileLanguage.VietTypeATL32.dll)" DefaultVersion="!(bind.fileVersion.VietTypeATL64.dll)" />
      </Component>
      <?endif ?>
    </ComponentGroup>
  </Fragment>

  <!-- ################################################################################ -->
  <!-- custom actions -->

  <Fragment>
    <CustomAction Id="RegisterCategories" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="deferred" />
    <CustomAction Id="RegisterCategoriesRollback" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="rollback" />
    <CustomAction Id="UnregisterCategories" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="deferred" />
    <CustomAction Id="UnregisterCategoriesRollback" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="rollback" />

    <CustomAction Id="RegisterProfiles" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="deferred" />
    <CustomAction Id="RegisterProfilesRollback" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="rollback" />
    <CustomAction Id="UnregisterProfiles" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="deferred" />
    <CustomAction Id="UnregisterProfilesRollback" BinaryKey="WixCA" DllEntry="WixQuietExec" Impersonate="no" Execute="rollback" />
  </Fragment>
</Wix>
